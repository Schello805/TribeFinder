// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String    @id @default(cuid())
  name                    String?
  email                   String    @unique
  emailVerified           DateTime?
  verificationToken       String?
  verificationTokenExpiry DateTime?
  password                String
  image                   String?
  role                    String    @default("USER") // "USER" or "ADMIN"
  isBlocked               Boolean   @default(false)

  // Profile Fields
  firstName  String?
  lastName   String?
  dancerName String?
  bio        String?

  isDancerProfileEnabled Boolean @default(false)
  isDancerProfilePrivate Boolean @default(false)

  dancerTeaches       Boolean @default(false)
  dancerTeachingWhere String?
  dancerTeachingFocus String?
  dancerEducation     String?
  dancerPerformances  String?

  dancerGivesWorkshops       Boolean @default(false)
  dancerBookableForShows     Boolean @default(false)
  dancerWorkshopConditions   String?

  // Dance Profile
  danceLevel String? // "BEGINNER", "INTERMEDIATE", "ADVANCED", "PROFESSIONAL"
  lookingFor String? // "GROUP", "PARTNER", "BOTH", "NONE"

  // Social Media
  instagramUrl String?
  facebookUrl  String?
  youtubeUrl   String?
  tiktokUrl    String?
  website      String?

  // Notification Preferences
  emailNotifications  Boolean @default(true)
  notifyDirectMessages Boolean @default(true)
  notifyInboxMessages Boolean @default(false)

  // Location-based Notification Preferences
  notifyNewGroups Boolean @default(false)
  notifyNewEvents Boolean @default(false)
  notifyLat       Float?
  notifyLng       Float?
  notifyRadius    Int     @default(50) // km

  resetToken       String?
  resetTokenExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  ownedGroups Group[]       @relation("GroupOwner")
  memberships GroupMember[]

  // Feature 2: Push Notifications
  pushSubscriptions PushSubscription[]

  createdEvents Event[] @relation("EventCreator")

  // Feature 3: Community Feed
  posts Post[]

  // Dance Styles
  danceStyles UserDanceStyle[]

  // Private Messages
  sentMessages     Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")

  directMessageEmailNotificationReceiverStates DirectMessageEmailNotificationState[] @relation("DirectMessageEmailNotificationReceiver")
  directMessageEmailNotificationSenderStates   DirectMessageEmailNotificationState[] @relation("DirectMessageEmailNotificationSender")

  adminAuditLogsAsActor AdminAuditLog[] @relation("AdminAuditActor")
  adminAuditLogTargets AdminAuditLog[] @relation("AdminAuditTargetUser")

  // Group contact inbox
  createdGroupThreads   GroupThread[]          @relation("GroupThreadCreator")
  groupThreadMessages   GroupThreadMessage[]   @relation("GroupThreadMessageAuthor")
  groupThreadReadStates GroupThreadReadState[]

  // Event Registrations
  eventRegistrations EventRegistration[]

  // Favorites
  favoriteGroups FavoriteGroup[]

  groupLikes GroupLike[]

  feedbacks Feedback[]

  danceStyleSuggestionsCreated DanceStyleSuggestion[] @relation("DanceStyleSuggestionCreatedBy")
  danceStyleSuggestionsDecided DanceStyleSuggestion[] @relation("DanceStyleSuggestionDecidedBy")

  danceStyleAliasSuggestionsCreated DanceStyleAliasSuggestion[] @relation("DanceStyleAliasSuggestionCreatedBy")
  danceStyleAliasSuggestionsDecided DanceStyleAliasSuggestion[] @relation("DanceStyleAliasSuggestionDecidedBy")

  marketplaceListings MarketplaceListing[]

  announcementDismissals AnnouncementDismissal[]
}

model Post {
  id      String  @id @default(cuid())
  content String
  image   String?

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventDanceStyle {
  id String @id @default(cuid())

  eventId String
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  styleId String
  style   DanceStyle @relation(fields: [styleId], references: [id], onDelete: Cascade)

  @@unique([eventId, styleId])
  @@index([styleId])
  @@index([eventId])
}

model PushSubscription {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint String
  p256dh   String
  auth     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([endpoint])
}

model Group {
  id                 String  @id @default(cuid())
  name               String
  description        String
  website            String?
  contactEmail       String?
  image              String?
  headerImage        String?
  headerImageFocusY  Int?
  headerGradientFrom String?
  headerGradientTo   String?
  videoUrl           String? // YouTube Link
  size               String  @default("SMALL") // SOLO, DUO, TRIO, SMALL (<10), LARGE (>10)

  trainingTime   String? // Free text for training times (e.g. "Mo 18:00-20:00")
  accessories    String? // Optional free text about used accessories
  performances   Boolean @default(false)
  foundingYear   Int?
  seekingMembers Boolean @default(false)

  ownerId String
  owner   User   @relation("GroupOwner", fields: [ownerId], references: [id])

  members GroupMember[]

  location            Location?
  tags                Tag[]
  danceStyles         GroupDanceStyle[]
  events              Event[]
  eventParticipations EventParticipation[]

  // Gallery (max 5 images)
  galleryImages GalleryImage[]

  // Contact inbox
  threads GroupThread[]

  // Favorites
  favoritedBy FavoriteGroup[]
  likes GroupLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GroupMember {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  role    String @default("MEMBER") // "ADMIN", "MEMBER"
  status  String @default("PENDING") // "PENDING", "APPROVED"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, groupId])
}

model GroupLike {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, groupId])
  @@index([groupId])
}

model FavoriteGroup {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, groupId])
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String
  eventType   String    @default("EVENT") // "EVENT", "WORKSHOP", "SOCIAL", "OPEN_TRAINING"
  startDate   DateTime
  endDate     DateTime?

  locationName String?
  address      String?
  lat          Float
  lng          Float

  flyer1 String?
  flyer2 String?

  website     String?
  ticketLink  String?
  ticketPrice String?

  organizer String? // Name of the organizer (person or group)

  // Workshop booking fields
  maxParticipants      Int? // null = unlimited
  requiresRegistration Boolean @default(false)

  groupId String?
  group   Group?  @relation(fields: [groupId], references: [id], onDelete: SetNull)

  creatorId String?
  creator   User?   @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  danceStyles EventDanceStyle[]

  participations EventParticipation[]
  registrations  EventRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventParticipation {
  id      String  @id @default(cuid())
  eventId String
  event   Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  groupId String
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  status  String  @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  message String? // Optional message from the group applying

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, groupId])
}

model Location {
  id      String  @id @default(cuid())
  address String?
  lat     Float
  lng     Float
  groupId String  @unique
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

model Tag {
  id         String  @id @default(cuid())
  name       String  @unique
  isApproved Boolean @default(false)
  type       TagType @default(GENERAL)
  groups     Group[]
}

enum TagType {
  GENERAL
  DIALECT
  PROP
}

enum DanceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  PROFESSIONAL
}

enum MarketplaceCategory {
  KOSTUEME
  SCHMUCK
  ACCESSOIRES
  SCHUHE
  SONSTIGES
}

enum MarketplaceListingType {
  OFFER
  REQUEST
}

enum MarketplacePriceType {
  FIXED
  NEGOTIABLE
}

enum MarketplaceLocationSource {
  PROFILE
  GEOCODE
}

enum MarketingAssetType {
  LOGO
  HEADER
  POSTER
}

model SystemSetting {
  key   String @id
  value String
}

model MarketingAsset {
  id          String             @id @default(cuid())
  type        MarketingAssetType
  title       String
  description String?
  fileUrl     String
  mimeType    String
  sizeBytes   Int

  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
}

model Feedback {
  id            String  @id @default(cuid())
  message       String
  reporterName  String?
  reporterEmail String?
  pageUrl       String?
  userAgent     String?
  browser       String?
  os            String?

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt  DateTime  @default(now())
  archivedAt DateTime?

  @@index([createdAt])
  @@index([userId])
  @@index([archivedAt])
}

model ErrorLog {
  id          String @id @default(cuid())
  fingerprint String @unique

  route  String?
  status Int?

  message String
  details String?
  stack   String?

  count       Int      @default(1)
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())

  lastEmailSentAt DateTime?

  @@index([lastSeenAt])
  @@index([status])
}

// ===== NEW FEATURES =====

// Gallery Images for Groups (max 5 per group)
model GalleryImage {
  id      String  @id @default(cuid())
  url     String
  caption String?
  order   Int     @default(0)

  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model MarketplaceListing {
  id String @id @default(cuid())

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  title       String
  description String
  category    MarketplaceCategory

  listingType MarketplaceListingType @default(OFFER)

  postalCode String?
  city       String?
  lat        Float?
  lng        Float?
  locationSource MarketplaceLocationSource?

  priceCents Int?
  priceType  MarketplacePriceType @default(FIXED)
  currency   String @default("EUR")

  shippingAvailable Boolean @default(false)
  shippingCostCents Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expiresAt      DateTime
  reminderSentAt DateTime?

  images MarketplaceListingImage[]

  @@index([category])
  @@index([expiresAt])
  @@index([ownerId])
  @@index([postalCode])
  @@index([city])
  @@index([lat])
  @@index([lng])
}

model MarketplaceListingImage {
  id String @id @default(cuid())

  listingId String
  listing   MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  url     String
  caption String?
  order   Int     @default(0)

  createdAt DateTime @default(now())

  @@unique([listingId, order])
  @@index([listingId])
}

enum DanceMode {
  IMPRO
  CHOREO
  BOTH
}

enum DanceStyleSuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DanceStyleAliasSuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

// Dance Styles (predefined list)
model DanceStyle {
  id       String  @id @default(cuid())
  name     String  @unique
  category String? // e.g. "Oriental", "Tribal", "Fusion"

  formerName String?
  websiteUrl  String?
  description String?
  videoUrl    String?

  aliases          DanceStyleAlias[]
  aliasSuggestions DanceStyleAliasSuggestion[]

  groupDanceStyles GroupDanceStyle[]
  userDanceStyles  UserDanceStyle[]
  eventDanceStyles EventDanceStyle[]

  approvedInSuggestions DanceStyleSuggestion[] @relation("DanceStyleSuggestionApproved")

  targetedSuggestions DanceStyleSuggestion[] @relation("DanceStyleSuggestionTarget")
}

model DanceStyleAlias {
  id String @id @default(cuid())

  name    String @unique
  styleId String
  style   DanceStyle @relation(fields: [styleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([styleId])
}

model DanceStyleAliasSuggestion {
  id String @id @default(cuid())

  aliasName String

  styleId String
  style   DanceStyle @relation(fields: [styleId], references: [id], onDelete: Cascade)

  sourceUrl String?
  comment   String?

  status DanceStyleAliasSuggestionStatus @default(PENDING)

  createdById String
  createdBy   User @relation("DanceStyleAliasSuggestionCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  decidedByAdminId String?
  decidedByAdmin   User? @relation("DanceStyleAliasSuggestionDecidedBy", fields: [decidedByAdminId], references: [id], onDelete: SetNull)

  decidedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([aliasName, styleId])
  @@index([status])
  @@index([createdById])
  @@index([styleId])
  @@index([decidedByAdminId])
}

// User's Dance Styles with Level
model UserDanceStyle {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  styleId String
  style   DanceStyle @relation(fields: [styleId], references: [id], onDelete: Cascade)

  level DanceLevel @default(BEGINNER)

  @@unique([userId, styleId])
}

model GroupDanceStyle {
  id String @id @default(cuid())

  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  styleId String
  style   DanceStyle @relation(fields: [styleId], references: [id], onDelete: Cascade)

  level DanceLevel @default(BEGINNER)

  mode DanceMode?

  @@unique([groupId, styleId])
}

model DanceStyleSuggestion {
  id String @id @default(cuid())

  name String
  category String?
  formerName String?
  websiteUrl String?
  description String?
  videoUrl String?

  styleId String?
  style   DanceStyle? @relation("DanceStyleSuggestionTarget", fields: [styleId], references: [id], onDelete: SetNull)

  status DanceStyleSuggestionStatus @default(PENDING)

  createdById String
  createdBy   User @relation("DanceStyleSuggestionCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  decidedByAdminId String?
  decidedByAdmin   User? @relation("DanceStyleSuggestionDecidedBy", fields: [decidedByAdminId], references: [id], onDelete: SetNull)

  approvedStyleId String?
  approvedStyle   DanceStyle? @relation("DanceStyleSuggestionApproved", fields: [approvedStyleId], references: [id], onDelete: SetNull)

  decidedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([approvedStyleId])
  @@index([styleId])
}

// Workshop/Event Registrations
model EventRegistration {
  id String @id @default(cuid())

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status String  @default("CONFIRMED") // "CONFIRMED", "WAITLIST", "CANCELLED"
  note   String? // Optional note from user

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId])
}

// Private Messages
model Message {
  id      String  @id @default(cuid())
  content String
  read    Boolean @default(false)

  senderId String
  sender   User   @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId String
  receiver   User   @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
}

model DirectMessageEmailNotificationState {
  id String @id @default(cuid())

  receiverId String
  receiver   User @relation("DirectMessageEmailNotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  senderId String
  sender   User @relation("DirectMessageEmailNotificationSender", fields: [senderId], references: [id], onDelete: Cascade)

  lastNotifiedAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([receiverId, senderId])
  @@index([receiverId])
  @@index([senderId])
}

model AdminAuditLog {
  id String @id @default(cuid())

  action String

  actorAdminId String
  actorAdmin   User @relation("AdminAuditActor", fields: [actorAdminId], references: [id], onDelete: Cascade)

  targetUserId String?
  targetUser   User? @relation("AdminAuditTargetUser", fields: [targetUserId], references: [id], onDelete: SetNull)

  targetBackupFilename String?

  metadata Json?

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([action])
  @@index([actorAdminId])
  @@index([targetUserId])
}

model Announcement {
  id String @id @default(cuid())

  title   String
  bullets Json

  showFrom  DateTime
  showUntil DateTime?
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dismissals AnnouncementDismissal[]

  @@index([isActive])
  @@index([showFrom])
  @@index([showUntil])
  @@index([createdAt])
}

model AnnouncementDismissal {
  id String @id @default(cuid())

  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  dismissedAt DateTime @default(now())

  @@unique([announcementId, userId])
  @@index([userId])
  @@index([dismissedAt])
}

// Group Contact Threads (Inbox)
model GroupThread {
  id String @id @default(cuid())

  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdByUserId String
  createdBy       User   @relation("GroupThreadCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  subject String?
  status  String  @default("OPEN") // OPEN, CLOSED

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())

  messages   GroupThreadMessage[]
  readStates GroupThreadReadState[]

  @@index([groupId])
  @@index([createdByUserId])
  @@index([lastMessageAt])
}

model GroupThreadMessage {
  id String @id @default(cuid())

  threadId String
  thread   GroupThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation("GroupThreadMessageAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  content   String
  createdAt DateTime @default(now())

  @@index([threadId])
  @@index([authorId])
}

model GroupThreadReadState {
  id String @id @default(cuid())

  threadId String
  thread   GroupThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  lastReadAt DateTime  @default(now())
  archivedAt DateTime?
  updatedAt  DateTime  @updatedAt

  @@unique([threadId, userId])
  @@index([userId])
  @@index([threadId])
}
